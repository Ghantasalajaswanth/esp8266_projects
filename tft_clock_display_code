#include <SPI.h>
#include <Adafruit_GFX.h>
#include <Adafruit_ILI9341.h>
#include <math.h>

// ===== TFT PINS (DO NOT CHANGE) =====
#define TFT_CS   15
#define TFT_DC   2
#define TFT_RST  4

Adafruit_ILI9341 tft(TFT_CS, TFT_DC, TFT_RST);

// Clock center & radius
#define CX 160
#define CY 120
#define RADIUS 95

int secondVal = 0;
int minuteVal = 10;
int hourVal   = 10;

// Store old values
int oldSec = -1, oldMin = -1, oldHr = -1;

void setup() {
  Serial.begin(115200);
  tft.begin();
  tft.setRotation(1);

  drawClockFace();   // âœ… draw ONCE
}

void loop() {

  // Erase old hands
  if (oldSec >= 0) {
    drawHands(oldHr, oldMin, oldSec, ILI9341_BLACK);
  }

  // Draw new hands
  drawHands(hourVal, minuteVal, secondVal, ILI9341_RED);

  // Save current as old
  oldSec = secondVal;
  oldMin = minuteVal;
  oldHr  = hourVal;

  delay(1000);

  // Time update
  secondVal++;
  if (secondVal >= 60) {
    secondVal = 0;
    minuteVal++;
  }
  if (minuteVal >= 60) {
    minuteVal = 0;
    hourVal++;
  }
  if (hourVal >= 12) hourVal = 0;
}

// ===== CLOCK FACE (DRAW ONCE) =====
void drawClockFace() {
  tft.fillScreen(ILI9341_BLACK);

  tft.drawCircle(CX, CY, RADIUS, ILI9341_GREEN);

  for (int i = 0; i < 60; i++) {
    float a = i * 6 * DEG_TO_RAD;
    tft.drawPixel(
      CX + cos(a) * (RADIUS - 4),
      CY + sin(a) * (RADIUS - 4),
      ILI9341_WHITE
    );
  }

  for (int i = 0; i < 12; i++) {
    float a = i * 30 * DEG_TO_RAD;
    tft.fillCircle(
      CX + cos(a) * (RADIUS - 10),
      CY + sin(a) * (RADIUS - 10),
      2,
      ILI9341_WHITE
    );
  }

  tft.setTextColor(ILI9341_RED);
  tft.setTextSize(2);
  tft.setCursor(90, 210);
  tft.print("ESP32 Clock");
}

// ===== DRAW / ERASE HANDS =====
void drawHands(int h, int m, int s, uint16_t color) {

  float secA = (s * 6 - 90) * DEG_TO_RAD;
  float minA = (m * 6 - 90) * DEG_TO_RAD;
  float hrA  = ((h % 12) * 30 + m * 0.5 - 90) * DEG_TO_RAD;

  // Second hand
  tft.drawLine(
    CX, CY,
    CX + cos(secA) * (RADIUS - 15),
    CY + sin(secA) * (RADIUS - 15),
    color
  );

  // Minute hand
  tft.drawLine(
    CX, CY,
    CX + cos(minA) * (RADIUS - 25),
    CY + sin(minA) * (RADIUS - 25),
    (color == ILI9341_BLACK) ? ILI9341_BLACK : ILI9341_WHITE
  );

  // Hour hand
  tft.drawLine(
    CX, CY,
    CX + cos(hrA) * (RADIUS - 40),
    CY + sin(hrA) * (RADIUS - 40),
    (color == ILI9341_BLACK) ? ILI9341_BLACK : ILI9341_CYAN
  );

  // Center dot
  tft.fillCircle(CX, CY, 4, ILI9341_WHITE);
}
